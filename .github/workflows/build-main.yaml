name: build-main

on:
  push:
    branches:
      - autoware
  pull_request:
    branches:
      - autoware
jobs:
  load-env:
    uses: ./.github/workflows/load-env.yaml

  build-main:
    needs: load-env
    runs-on: ubuntu-latest
    container: ${{ needs.load-env.outputs.base-image }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Run setup script
        run: |
          chmod +x ./setup-dev-env.sh 
          ./setup-dev-env.sh -y

      - name: Set git config
        uses: autowarefoundation/autoware-github-actions/set-git-config@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run vcs import
        run: |
          mkdir src
          vcs import src < autoware.repos

      - name: Run vcs export
        run: |
          vcs export --exact src || true

      - name: Run rosdep install
        run: |
          sudo apt-get -y update
          rosdep update
          DEBIAN_FRONTEND=noninteractive rosdep install -y --from-paths src --ignore-src --rosdistro ${{ needs.load-env.outputs.rosdistro }}

      - name: Build
        run: |
          . /opt/ros/${{ needs.load-env.outputs.rosdistro }}/setup.sh
          colcon build --event-handlers console_cohesion+ --cmake-args -DCMAKE_BUILD_TYPE=Release

# name: build-main

# on:
#   push:
#     branches:
#       - autoware
#   pull_request:
#     branches:
#       - autoware

# jobs:
#   load-env:
#     uses: ./.github/workflows/load-env.yaml

#   build-main:
#     needs: load-env
#     runs-on: ubuntu-latest
#     container: ${{ needs.load-env.outputs.base-image }}
#     steps:
#       - name: Checkout Repository  
#         uses: actions/checkout@v3

#       - name: Run Setup Script 
#         run: |
#           ./setup-dev-env.sh -y

#       - name: Set Git Config  
#         uses: autowarefoundation/autoware-github-actions/set-git-config@v1
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}

#       - name: Import Main Repositories  # 导入主要仓库
#         run: |
#           mkdir src
#           vcs import src < autoware.repos

#       - name: Import Simulator Repositories  # 导入模拟器仓库
#         run: |
#           vcs import src < simulator.repos

#       - name: Run VCS Export  # 运行VCS导出
#         run: |
#           vcs export --exact src || true

#       - name: Install ROS Dependencies  # 安装ROS依赖
#         run: |
#           sudo apt-get -y update
#           rosdep update
#           DEBIAN_FRONTEND=noninteractive rosdep install -y --from-paths src --ignore-src --rosdistro ${{ needs.load-env.outputs.rosdistro }}

#       - name: Build Code  # 构建代码
#         run: |
#           . /opt/ros/${{ needs.load-env.outputs.rosdistro }}/setup.sh
#           colcon build --event-handlers console_cohesion+ --cmake-args -DCMAKE_BUILD_TYPE=Release

      # - name: Generate Test Configuration  # 生成测试配置文件
      #   run: |
      #     python3 .github/scripts/generate_test_configuration.py

      # - name: Display new_workflow.yaml  # 显示new_workflow.yaml
      #   run: cat test_runner/scenario_test_runner/config/new_workflow.yaml

      # - name: Run Scenario Test  # 运行场景测试
      #   run: |
      #     source /opt/ros/${{ needs.load-env.outputs.rosdistro }}/setup.sh
      #     source install/local_setup.sh
      #     ros2 launch scenario_test_runner scenario_test_runner.launch.py workflow:='/path/to/config/new_workflow.yaml' global_frame_rate:=20
      #     ros2 run scenario_test_runner result_checker.py /tmp/scenario_test_runner/result.junit.xml

